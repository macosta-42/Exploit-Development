#!/bin/bash

MY_IP=$(hostname -I | cut -d " " -f 3)
BASE_IP=$(hostname -I | cut -d " " -f 3 | cut -d '.' -f 1-3)
NETWORK=$BASE_IP".1/24"
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
NC='\033[0m'

printf "\n${GREEN}[+] Creating directory [+]${NC}\n"
mkdir -p discovery

printf "\n${GREEN}[+] Starting nmap discovery [+]${NC}\n"
sudo nmap -sn $NETWORK -oN discovery/discovery.nmap

printf "\n${GREEN}[+] Formating discovered IPs [+]${NC}\n"
cat discovery/discovery.nmap | grep for | grep -v "\<${MY_IP}\>" | cut -d " " -f 5 > discovery/ips.txt
while read ip; do
	printf "\n${ORANGE}$ip${NC}"
done <discovery/ips.txt

printf "\n${GREEN}[+] nmap initial scan on IPs [+]${NC}\n"
while read ip; do
	mkdir -p discovery/$ip
	printf "\n${GREEN}[+] ${ORANGE}$ip${GREEN} initial scan [+]${NC}\n"
	sudo nmap --min-rate 500 -T4 -p- -n -Pn -oA discovery/$ip/initial $ip --open -v
	cat discovery/$ip/initial.xml | grep portid | cut -d '"' -f 4 > tmp.txt
	paste -s -d, tmp.txt > discovery/$ip/ports.txt && rm tmp.txt
done <discovery/ips.txt

printf "\n${GREEN}[+] nmap services scan on IPs [+]${NC}\n"
while read ip; do
	printf "\n${GREEN}[+] ${ORANGE}$ip${GREEN} services scan [+]${NC}\n"
	ports=$(cat discovery/$ip/ports.txt)
	sudo nmap -sC -sV -O -p $ports -n -Pn -oA discovery/$ip/services $ip -v
done <discovery/ips.txt