#!/bin/bash

MY_IP=$(hostname -I | cut -d " " -f 3)
BASE_IP=$(hostname -I | cut -d " " -f 3 | cut -d '.' -f 1-3)
NETWORK=$BASE_IP".0/24"

GREEN='\033[0;32m'
ORANGE='\033[0;33m'
NC='\033[0m'

function ft_get_ports {
	cat $1/nmap/01_fullscan.xml | grep syn-ack | cut -d '"' -f 4 > tmp.txt
	paste -s -d, tmp.txt > $1/nmap/ports.txt && rm tmp.txt
}

function ft_scan {
	sudo nmap --min-rate 500 -T4 -F -oN $1/nmap/00_initial.txt $1 --open > /dev/null 2>&1
	sudo nmap --min-rate 500 -T4 -sC -sV -O -p- -oN $1/nmap/01_fullscan.txt -oX $1/nmap/01_fullscan.xml $1 > /dev/null 2>&1 && \
	ft_get_ports "$1" && \
	PORTS=$(cat $1/nmap/ports.txt) && \
	sudo nmap -Pn --script vuln -sV -p $PORTS -oN $1/nmap/02_vuln.txt $1 > /dev/null 2>&1
	sudo nmap --min-rate 500 -sU -O -T4 -p- -oN $1/nmap/03_udp.txt $1 > /dev/null 2>&1
}

clear
printf "${GREEN} ____  _____ ____ ___  _   _ \n"
printf "|  _ \| ____/ ___/ _ \| \ | |\n"
printf "| |_) |  _|| |  | | | |  \| |\n"
printf "|  _ <| |__| |__| |_| | |\  |\n"
printf "|_| \_|_____\____\___/|_| \_|${NC}\n"

printf "\n${GREEN}[+] Starting nmap discovery [+]${NC}\n"
sudo nmap -sn ${NETWORK} --exclude ${MY_IP} -oN recon.nmap &>/dev/null
cat recon.nmap | grep for | cut -d ' ' -f 5 > ip_list.txt && sudo rm recon.nmap
while read ip; do
	printf "\n${ORANGE}$ip${NC}"
	mkdir -p $ip/nmap
done <ip_list.txt

printf "\n${GREEN}[+] nmap scan on IPs [+]${NC}\n"
while read ip; do
	printf "\n${GREEN}[+] Starting scans on: ${ORANGE}$ip${GREEN} [+]${NC}\n"
	ft_scan "$ip" > /dev/null 2>&1 &
done <ip_list.txt

printf "\n${GREEN}[+] Starting python server [+]${NC}\n"
ps -fA | grep python | grep 9999 | cut -d ' ' -f 8 > kill.txt
while read process; do
	sudo kill $process &>/dev/null
done<kill.txt
rm kill.txt
sudo python3 -m http.server 9999 &>/dev/null &

printf "\n${GREEN}[+] Starting firefox [+]${NC}\n"
/usr/bin/firefox localhost:9999 &>/dev/null &

printf "\n${GREEN}[+] cmd to stop server: kill %%1 [+]${NC}\n"
