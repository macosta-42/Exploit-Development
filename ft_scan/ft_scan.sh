#!/bin/bash

GREEN='\033[0;32m'
NC='\033[0m'

clear

#Banner
printf "${GREEN}    ______                           \n"
printf "   / __/ /_     ______________  ____ \n"
printf "  / /_/ __/    / ___/ ___/ __ '/ __ \ \n"
printf " / __/ /_     (__  ) /__/ /_/ / / / /\n"
printf "/_/  \__/____/____/\___/\__,_/_/ /_/ \n"
printf "       /_____/                       ${NC}\n"

#Check argument number
if [ "$#" -ne 1 ]; then
    printf "${GREEN}\n[!] Usage: $0 [RHOST] [!]${NC}\n"
    exit 1
fi

#Check RHOST length
if [ $#1 -ge 16 ];
then
  printf "${GREEN}\n[!] Invalid RHOST [!]${NC}\n"
  exit 1
else
  target=$1
fi

#check for root
uid=$(id -u)
if [ x$uid != x0 ]
then
    printf -v cmd_str '%q ' "$0" "$@"
    exec sudo su -c "$cmd_str"
fi

#Check for dependencies
if ! command -v nmap &> /dev/null
then
    printf "${GREEN}\n[*] Installing nmap... [*]${NC}\n"
    sudo apt-get install nmap -y
fi

if ! command -v xsltproc &> /dev/null
then
    printf "${GREEN}\n[*] Installing xsltproc... [*]\n${NC}"
    sudo apt-get install xsltproc -y
fi

#Create directories
printf "${GREEN}\n[+] Creating Directory [+]\n${NC}"
mkdir -p ${target}/nmap

#Starting HTTP server
user_authority=$(echo $XAUTHORITY | rev | cut -d '/' -f 2 | rev)
printf "${GREEN}\n[+] Launching HTTP server [+]\n${NC}"
sudo -H -u $user_authority mate-terminal -e "python3 -m http.server 9999" &

#Starting Firefox
printf "${GREEN}\n[+] Launching Firefox [+]\n${NC}"
sudo -H -u $user_authority mate-terminal --tab -e "firefox -private localhost:9999" &

#Initial basic very fast scan
printf "${GREEN}\n[+] Basic scan [+]\n${NC}"
sudo nmap --min-rate 500 -T4 -F -oX ${target}/nmap/00_initial.xml ${target} --open -v
xsltproc ${target}/nmap/00_initial.xml -o ${target}/nmap/00_initial.html
sudo rm ${target}/nmap/00_initial.xml

#Fullport scan with service discovery
printf "${GREEN}\n[+] Fullport scan [+]\n${NC}"
sudo nmap --min-rate 500 -T4 -sC -sV -O -p- -oX ${target}/nmap/01_fullscan.xml ${target}
xsltproc ${target}/nmap/01_fullscan.xml -o ${target}/nmap/01_fullscan.html

#Extract open ports
cat ${target}/nmap/01_fullscan.xml | grep syn-ack | cut -d '"' -f 4 > tmp.txt
paste -s -d, tmp.txt > ${target}/nmap/ports.txt
sudo rm tmp.txt
sudo rm ${target}/nmap/01_fullscan.xml
ports=$(cat ${target}/nmap/ports.txt)
sudo rm ${target}/nmap/ports.txt

#Vuln scan on open ports
printf "${GREEN}\n[+] Vulnerability scan [+]\n${NC}"
sudo nmap -Pn --script vuln -sV -p ${ports} -oX ${target}/nmap/02_vuln.xml ${target}
rm ${target}/nmap/ports.txt
xsltproc ${target}/nmap/02_vuln.xml -o ${target}/nmap/02_vuln.html
sudo rm ${target}/nmap/02_vuln.xml

#UDP scan
printf "${GREEN}\n[+] UDP scan [+]\n${NC}"
sudo nmap --min-rate 500 -sU -O -T4 -p- -oX ${target}/nmap/03_udp.xml ${target}
xsltproc ${target}/nmap/03_udp.xml -o ${target}/nmap/03_udp.html
sudo rm ${target}/nmap/03_udp.xml

sudo chown -R ${user_authority}:${user_authority} ${target}
